class SearchComponent{constructor(){this.searchIndex=null,this.searchData=null,this.searchInput=null,this.searchResults=null,this.searchFilters=null,this.isLoading=!1,this.currentResults=[],this.selectedIndex=-1,this.searchDebounce=null,this.debounceDelay=150,this.maxResults=50,this.minQueryLength=2,this.handleSearchInput=this.handleSearchInput.bind(this),this.handleKeydown=this.handleKeydown.bind(this),this.handleFilterChange=this.handleFilterChange.bind(this),this.handleResultClick=this.handleResultClick.bind(this),this.handleDocumentClick=this.handleDocumentClick.bind(this),this.init()}async init(){this.createSearchInterface(),this.setupEventListeners();try{await this.loadSearchData(),this.buildSearchIndex(),this.enableSearch()}catch(error){console.error("Failed to initialize search:",error),this.showError("Search functionality unavailable")}}createSearchInterface(){if(!document.querySelector(".search-container")){const searchHTML=this.getSearchHTML(),mainContent=document.querySelector(".main-content, main, body");mainContent&&mainContent.insertAdjacentHTML("afterbegin",searchHTML)}if(this.searchInput=document.getElementById("people-search"),this.searchResults=document.getElementById("search-results"),this.searchFilters=document.querySelectorAll('.search-filters input[type="checkbox"]'),this.searchContainer=document.querySelector(".search-container"),!this.searchInput)return void console.warn("Search input not found - search functionality disabled");this.searchContainer&&this.searchContainer.classList.remove("active");const searchClose=document.querySelector(".search-close");searchClose&&searchClose.addEventListener("click",()=>{this.searchContainer&&this.searchContainer.classList.remove("active")})}getSearchHTML(){return'\n            <div class="search-container">\n                <div class="search-header">\n                    <h3>Search Family Members</h3>\n                    <button class="search-close" aria-label="Close search">&times;</button>\n                </div>\n                <div class="search-wrapper">\n                    <input type="search"\n                           id="people-search"\n                           placeholder="Search people, dates, locations..."\n                           autocomplete="off"\n                           aria-label="Search genealogy database"\n                           aria-describedby="search-help"\n                           disabled>\n                    <div class="search-filters">\n                        <label><input type="checkbox" value="name" checked> Names</label>\n                        <label><input type="checkbox" value="date"> Dates</label>\n                        <label><input type="checkbox" value="location"> Locations</label>\n                        <label><input type="checkbox" value="lineage"> Lineage</label>\n                    </div>\n                    <div id="search-help" class="sr-only">\n                        Use this search to find people, dates, and locations in the genealogy database.\n                        Results will appear below as you type.\n                    </div>\n                </div>\n                <div class="search-results" id="search-results" hidden aria-live="polite">\n                    \x3c!-- Search results populated here --\x3e\n                </div>\n            </div>\n        '}setupEventListeners(){this.searchInput&&(this.searchInput.addEventListener("input",this.handleSearchInput),this.searchInput.addEventListener("keydown",this.handleKeydown),this.searchInput.addEventListener("focus",()=>{this.currentResults.length>0&&this.showResults()})),this.searchFilters&&this.searchFilters.forEach(filter=>{filter.addEventListener("change",this.handleFilterChange)}),document.addEventListener("click",this.handleDocumentClick)}async loadSearchData(){if(!this.isLoading){this.isLoading=!0,this.showLoading();try{const response=await fetch("/auntruth/new/js/data.json");if(!response.ok)throw new Error(`HTTP ${response.status}: ${response.statusText}`);if(this.searchData=await response.json(),!this.searchData||!this.searchData.people)throw new Error("Invalid search data format");console.log(`Loaded ${this.searchData.people.length} people for search`)}catch(error){throw console.error("Failed to load search data:",error),error}finally{this.isLoading=!1,this.hideLoading()}}}buildSearchIndex(){if(this.searchData&&window.lunr)try{const searchData=this.searchData;this.searchIndex=lunr(function(){this.field("name",{boost:10}),this.field("birthDate",{boost:5}),this.field("birthLocation",{boost:3}),this.field("lineage",{boost:7}),this.field("spouse",{boost:2}),this.field("children",{boost:2}),this.field("occupation"),this.field("notes"),this.ref("id");const lunrBuilder=this;searchData.people.forEach(function(person){lunrBuilder.add(person)})}),console.log("Search index built successfully")}catch(error){console.error("Failed to build search index:",error),this.searchIndex=null}else console.warn("Lunr.js not available - falling back to simple search")}enableSearch(){this.searchInput&&(this.searchInput.disabled=!1,this.searchInput.placeholder="Search people, dates, locations...")}handleSearchInput(event){const query=event.target.value.trim();this.searchDebounce&&clearTimeout(this.searchDebounce),this.searchDebounce=setTimeout(()=>{this.performSearch(query)},this.debounceDelay)}handleKeydown(event){if(this.searchResults&&0!==this.currentResults.length)switch(event.key){case"ArrowDown":event.preventDefault(),this.selectNext();break;case"ArrowUp":event.preventDefault(),this.selectPrevious();break;case"Enter":event.preventDefault(),this.selectCurrent();break;case"Escape":this.hideResults(),this.searchInput.blur()}}handleFilterChange(){const query=this.searchInput?this.searchInput.value.trim():"";query.length>=this.minQueryLength&&this.performSearch(query)}handleResultClick(event){const resultItem=event.target.closest(".search-result-item");if(resultItem){const url=resultItem.getAttribute("data-url");url&&(window.location.href=url)}}handleDocumentClick(event){const searchContainer=document.querySelector(".search-container");searchContainer&&!searchContainer.contains(event.target)&&this.hideResults()}performSearch(query){if(query.length<this.minQueryLength)this.hideResults();else if(this.searchData)try{let results;results=this.searchIndex&&window.lunr?this.searchWithLunr(query):this.searchSimple(query),results=this.applyFilters(results),results=results.slice(0,this.maxResults),this.currentResults=results,this.displayResults(results,query)}catch(error){console.error("Search error:",error),this.showError("Search failed")}else this.showError("Search data not available")}searchWithLunr(query){try{return this.searchIndex.search(query+"*").map(result=>({...this.searchData.people.find(p=>p.id===result.ref),score:result.score,matches:result.matchData})).filter(Boolean)}catch(error){return console.warn("Lunr search failed, falling back to simple search:",error),this.searchSimple(query)}}searchSimple(query){const queryLower=query.toLowerCase();return this.searchData.people.filter(person=>person.name&&person.name.toLowerCase().includes(queryLower)||person.birthLocation&&person.birthLocation.toLowerCase().includes(queryLower)||person.lineage&&person.lineage.toLowerCase().includes(queryLower)||person.spouse&&person.spouse.toLowerCase().includes(queryLower)||person.birthDate&&person.birthDate.includes(queryLower)).map(person=>({...person,score:this.calculateSimpleScore(person,queryLower)})).sort((a,b)=>b.score-a.score)}calculateSimpleScore(person,query){let score=0;return person.name&&person.name.toLowerCase().includes(query)&&(score+=person.name.toLowerCase().startsWith(query)?10:5),person.lineage&&person.lineage.toLowerCase().includes(query)&&(score+=3),person.birthLocation&&person.birthLocation.toLowerCase().includes(query)&&(score+=2),score}applyFilters(results){return Array.from(this.searchFilters||[]).filter(filter=>filter.checked).map(filter=>filter.value).length,results}displayResults(results,query){if(this.searchResults){if(this.selectedIndex=-1,0===results.length)this.searchResults.innerHTML=`\n                <div class="search-no-results">\n                    <p>No results found for "${query}"</p>\n                    <p>Try:</p>\n                    <ul>\n                        <li>Checking your spelling</li>\n                        <li>Using fewer words</li>\n                        <li>Using different search terms</li>\n                    </ul>\n                </div>\n            `;else{const resultsHTML=results.map((person,index)=>this.renderSearchResult(person,index)).join("");this.searchResults.innerHTML=resultsHTML,this.searchResults.addEventListener("click",this.handleResultClick)}this.showResults(),this.announceResults(results.length,query)}}renderSearchResult(person,index){return`\n            <div class="search-result-item"\n                 data-url="${person.url||`/auntruth/new/htm/L${person.lineage||"0"}/${person.filename||person.id}.htm`}"\n                 data-index="${index}"\n                 role="option"\n                 aria-selected="false">\n                <div class="search-result-name">${this.escapeHtml(person.name||"Unknown")}</div>\n                <div class="search-result-details">\n                    ${person.birthDate?`Born: ${this.escapeHtml(person.birthDate)}`:""}\n                    ${person.birthLocation?` in ${this.escapeHtml(person.birthLocation)}`:""}\n                    ${person.spouse?` • Spouse: ${this.escapeHtml(person.spouse)}`:""}\n                </div>\n                <div class="search-result-lineage">\n                    Lineage: ${this.escapeHtml(person.lineageName||person.lineage||"Unknown")}\n                </div>\n            </div>\n        `}selectNext(){0!==this.currentResults.length&&(this.selectedIndex=Math.min(this.selectedIndex+1,this.currentResults.length-1),this.updateSelection())}selectPrevious(){0!==this.currentResults.length&&(this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.updateSelection())}selectCurrent(){if(this.selectedIndex>=0&&this.selectedIndex<this.currentResults.length){const person=this.currentResults[this.selectedIndex],url=person.url||`/auntruth/new/htm/L${person.lineage||"0"}/${person.filename||person.id}.htm`;window.location.href=url}}updateSelection(){this.searchResults.querySelectorAll(".search-result-item").forEach((item,index)=>{const isSelected=index===this.selectedIndex;if(item.setAttribute("aria-selected",isSelected.toString()),isSelected){item.classList.add("selected"),item.scrollIntoView({block:"nearest"});const announcement=`${item.querySelector(".search-result-name").textContent} selected`;this.announceToScreenReader(announcement)}else item.classList.remove("selected")})}showResults(){this.searchResults&&(this.searchResults.hidden=!1,this.searchResults.setAttribute("aria-expanded","true"))}hideResults(){this.searchResults&&(this.searchResults.hidden=!0,this.searchResults.setAttribute("aria-expanded","false")),this.selectedIndex=-1}showLoading(){this.searchInput&&(this.searchInput.placeholder="Loading search data...")}hideLoading(){this.searchInput&&(this.searchInput.placeholder="Search people, dates, locations...")}showError(message){this.searchResults&&(this.searchResults.innerHTML=`\n                <div class="search-error">\n                    <p>⚠️ ${message}</p>\n                </div>\n            `,this.showResults())}announceResults(count,query){const message=0===count?`No results found for ${query}`:`${count} result${1===count?"":"s"} found for ${query}`;this.announceToScreenReader(message)}announceToScreenReader(message){const announcement=document.createElement("div");announcement.setAttribute("aria-live","polite"),announcement.setAttribute("aria-atomic","true"),announcement.className="sr-only",announcement.textContent=message,document.body.appendChild(announcement),setTimeout(()=>{document.body.removeChild(announcement)},1e3)}escapeHtml(text){const div=document.createElement("div");return div.textContent=text,div.innerHTML}}function loadLunr(){return new Promise((resolve,reject)=>{if(window.lunr)return void resolve();const script=document.createElement("script");script.src="https://unpkg.com/lunr@2.3.9/lunr.min.js",script.onload=resolve,script.onerror=()=>{console.warn("Failed to load Lunr.js - search will use simple fallback"),resolve()},document.head.appendChild(script)})}document.addEventListener("DOMContentLoaded",async()=>{if(!window.location.pathname.includes("/htm/")||window.location.pathname.includes("/new/"))try{await loadLunr(),new SearchComponent}catch(error){console.error("Failed to initialize search component:",error)}}),window.SearchComponent=SearchComponent;